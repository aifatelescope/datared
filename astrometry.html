
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Astrometric calibration &#8212; AIfA telescope data reduction tutorial</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'astrometry';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Photometry" href="photometry.html" />
    <link rel="prev" title="Image pre-reduction" href="pre-red.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="AIfA telescope data reduction tutorial - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="AIfA telescope data reduction tutorial - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    AIfA telescope data reduction tutorial
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction and setup</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="background-info.html">Introduction to optical observations</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Requirements and installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview-pythontools.html">Structure and Python tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="data.html">Setting up the data</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Basic reduction</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="pre-red.html">Image pre-reduction</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Astrometric calibration</a></li>
<li class="toctree-l1"><a class="reference internal" href="photometry.html">Photometry</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="CMD.html">Colour-magnitude diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="lightcurve.html">Exoplanet transit light curve</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Further content</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="stack.html">Reprojecting, stacking and colour-combination</a></li>
<li class="toctree-l1"><a class="reference internal" href="camera-charact.html">Camera characterization</a></li>
<li class="toctree-l1"><a class="reference internal" href="more.html">References and links</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/aifatelescope/datared" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/aifatelescope/datared/issues/new?title=Issue%20on%20page%20%2Fastrometry.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/astrometry.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Astrometric calibration</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="astrometric-calibration">
<h1>Astrometric calibration<a class="headerlink" href="#astrometric-calibration" title="Link to this heading">#</a></h1>
<p>This page presents a way get an accurate WCS-transformation for the science frames.</p>
<p>We make use of the local <code class="docutils literal notranslate"><span class="pre">astrometry.net</span></code> (see <a class="reference internal" href="installation.html"><span class="std std-doc">Requirements and installation</span></a>), calling it from within python via <code class="docutils literal notranslate"><span class="pre">subprocess</span></code>. The executable of <code class="docutils literal notranslate"><span class="pre">astrometry.net</span></code> that we will use is <code class="docutils literal notranslate"><span class="pre">solve-field</span></code>. For each image, we will call <code class="docutils literal notranslate"><span class="pre">solve-field</span></code> twice, with different settings. The first iteration is for rough plate-solving (identifying where the image is on the sky), and the second iteration is to fine-tune a distortion model. The page <a class="reference internal" href="installation.html"><span class="std std-doc">Requirements and installation</span></a> gives more information and links about <code class="docutils literal notranslate"><span class="pre">astrometry.net</span></code>. You are of course very welcome to learn more about this rather fascinating tool, but for the purpose of this lab course this notebook could in principle be run as a black box.</p>
<p>The ambition of this notebook is to obtain a WCS that is accurate enough for forced aperture photometry or stacking, i.e., with astrometric residuals significantly smaller than a pixel. This notebook will therefore also create a plot of astrometric residuals of each image to check this.</p>
<p>One note on the algorithmic approach: all our images are taken with the same camera/telescope, however we will constrain the distortion model independently for every image.
While this might not seem to be very elegant (in particular given a potentially low number of stars per image), this approach remains very flexible, and works even when the camera got rotated (for example) or when flexion in the telescope affects the distortion.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In case you’re using this tutorial with <strong>your own telescope setup</strong> (i.e., not the AIfA telescope), simply either adapt (or remove!) the hard-coded pixel scale parameters <code class="docutils literal notranslate"><span class="pre">--scale-low</span></code> and <code class="docutils literal notranslate"><span class="pre">--scale-high</span></code> as well as <code class="docutils literal notranslate"><span class="pre">--downsample</span></code> from the call to <code class="docutils literal notranslate"><span class="pre">solve-field</span></code> below. These parameters are optional, they are provided here only to speed up the process. Note that if your telescope has a field of view much narrower or wider than about 0.5 deg, you might need different index files (see links on <a class="reference internal" href="installation.html"><span class="std std-doc">Requirements and installation</span></a>).</p>
</div>
<p>As before, you could copy or write the code shown below in a script, or alternatively directly download this page as a <a class="reference download internal" download="" href="_downloads/b0a3b9fdbc44c20450042e257e32afda/astrometry.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">jupyter</span> <span class="pre">notebook</span></code></a> file.</p>
<p>To run the code, you’ll need the module <code class="docutils literal notranslate"><span class="pre">dataredconfig.py</span></code>, as explained <a class="reference internal" href="data.html"><span class="std std-doc">here</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dataredconfig</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.visualization</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>

<span class="o">%</span><span class="k">matplotlib</span> widget
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ccdproc</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Locating the image files to run on:</span>

<span class="n">input_dir</span> <span class="o">=</span> <span class="n">dataredconfig</span><span class="o">.</span><span class="n">work_dir</span> <span class="o">/</span> <span class="s2">&quot;LIGHT_PRERED&quot;</span>

<span class="n">science_files</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">ImageFileCollection</span><span class="p">(</span><span class="n">input_dir</span><span class="p">,</span> <span class="n">keywords</span><span class="o">=</span><span class="n">dataredconfig</span><span class="o">.</span><span class="n">ifc_header_keywords</span><span class="p">)</span>

<span class="c1"># You may want to use only some of the files in there, for example:</span>
<span class="c1">#object_to_process = &quot;HD92670&quot;</span>
<span class="c1">#science_files = science_files.filter(object=object_to_process)</span>

<span class="c1"># Overview of science files:</span>
<span class="n">science_files</span><span class="o">.</span><span class="n">summary</span>
<span class="c1"># You may want to try this instead, for a better display:</span>
<span class="c1">#science_files.summary.show_in_notebook()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Directory in which to write the output files:</span>

<span class="n">astrometry_dir</span> <span class="o">=</span> <span class="n">dataredconfig</span><span class="o">.</span><span class="n">work_dir</span> <span class="o">/</span> <span class="s2">&quot;ASTROMETRY&quot;</span>
<span class="n">astrometry_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Subdirectories for the two runs:</span>

<span class="n">run_1_dir</span> <span class="o">=</span> <span class="n">astrometry_dir</span> <span class="o">/</span> <span class="s2">&quot;run_1&quot;</span>
<span class="n">run_1_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">run_2_dir</span> <span class="o">=</span> <span class="n">astrometry_dir</span> <span class="c1"># The output of run2 is directly written into the astrometry_dir</span>
<span class="n">run_2_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># So after this notebook is done, you will want to use the files that are directly inside your astrometry_dir for the next steps.</span>
</pre></div>
</div>
</div>
</div>
<p>We now define one function for visualization.
As you will see once it has run, the generated plot is relatively self-explanatory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">visualize_corr_file</span><span class="p">(</span><span class="n">corr_file_path</span><span class="p">,</span> <span class="n">fig_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to vizualize the quality of the astrometric solution</span>

<span class="sd">    corr_file_path is the path to a .corr file as written by solve-field</span>

<span class="sd">    Specify either fig_file_path (figure will be written there), or a matplotlib </span>
<span class="sd">    axes object (will plot on these axes).</span>
<span class="sd">    &quot;&quot;&quot;</span>
     
    <span class="c1"># solve-field writes these &quot;corr&quot; tables with all &quot;corresponding&quot; stars it uses, we open them:</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">corr_file_path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;fits&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Read </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span><span class="si">}</span><span class="s2"> stars from corr file...&quot;</span><span class="p">)</span>


    <span class="n">corr</span><span class="p">[</span><span class="s2">&quot;error_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s2">&quot;field_x&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">corr</span><span class="p">[</span><span class="s2">&quot;index_x&quot;</span><span class="p">]</span>
    <span class="n">corr</span><span class="p">[</span><span class="s2">&quot;error_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s2">&quot;field_y&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">corr</span><span class="p">[</span><span class="s2">&quot;index_y&quot;</span><span class="p">]</span>
    <span class="n">corr</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">corr</span><span class="p">[</span><span class="s2">&quot;error_x&quot;</span><span class="p">],</span> <span class="n">corr</span><span class="p">[</span><span class="s2">&quot;error_y&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">fig_file_path</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">ax</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Provide either fig_file_path or ax!&quot;</span><span class="p">)</span>

    <span class="c1">#ax.plot(corr[&quot;field_x&quot;], corr[&quot;field_y&quot;], &quot;r.&quot;)</span>
    
    <span class="n">q</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">corr</span><span class="p">[</span><span class="s2">&quot;field_x&quot;</span><span class="p">],</span> <span class="n">corr</span><span class="p">[</span><span class="s2">&quot;field_y&quot;</span><span class="p">],</span> <span class="n">corr</span><span class="p">[</span><span class="s2">&quot;error_x&quot;</span><span class="p">],</span> <span class="n">corr</span><span class="p">[</span><span class="s2">&quot;error_y&quot;</span><span class="p">],</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;dots&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
    <span class="n">qk</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">quiverkey</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Astrometric error of 1 pixel&quot;</span><span class="p">,</span> <span class="n">labelpos</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">=</span><span class="s1">&#39;figure&#39;</span><span class="p">)</span>
    
    <span class="n">cm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colormaps</span><span class="p">[</span><span class="s1">&#39;RdYlBu_r&#39;</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">corr</span><span class="p">[</span><span class="s2">&quot;field_x&quot;</span><span class="p">],</span> <span class="n">corr</span><span class="p">[</span><span class="s2">&quot;field_y&quot;</span><span class="p">],</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span>
    <span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;x [pixel]&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;y [pixel]&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">fig_file_path</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_file_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
</pre></div>
</div>
</div>
</div>
<p>And a function to run <code class="docutils literal notranslate"><span class="pre">solve-field</span></code>. See the documentation of <code class="docutils literal notranslate"><span class="pre">astrometry.net</span></code> (<a class="reference external" href="http://astrometry.net/doc/readme.html">http://astrometry.net/doc/readme.html</a>) and the man-page of <code class="docutils literal notranslate"><span class="pre">solve-field</span></code> (<a class="reference external" href="https://manpages.debian.org/bullseye/astrometry.net/solve-field.1.en.html">https://manpages.debian.org/bullseye/astrometry.net/solve-field.1.en.html</a>) to learn more about the options we use below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">run_solvefield</span><span class="p">(</span><span class="n">input_fits_path</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">input_wcs_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper to run solve-field in a subprocess, with some hard-coded settings.</span>

<span class="sd">    The stdout and stderr are written to text files, as &quot;logs&quot; to check in case of problems. </span>
<span class="sd">    Use settings=2 and provide the wcs of run 1 when running for the second time, to fine-tune the SIP.</span>

<span class="sd">    A log file gets written along the other output files from solve-field</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cmd_1</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;solve-field&quot;</span><span class="p">,</span>
           <span class="s2">&quot;--overwrite&quot;</span><span class="p">,</span>
           <span class="s2">&quot;--scale-units&quot;</span><span class="p">,</span> <span class="s2">&quot;arcsecperpix&quot;</span><span class="p">,</span>
           <span class="s2">&quot;--scale-low&quot;</span><span class="p">,</span> <span class="s2">&quot;0.60&quot;</span><span class="p">,</span>
           <span class="s2">&quot;--scale-high&quot;</span><span class="p">,</span> <span class="s2">&quot;0.62&quot;</span><span class="p">,</span>
           <span class="s2">&quot;--downsample&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span>
           <span class="s2">&quot;--crpix-center&quot;</span><span class="p">,</span>
           <span class="s2">&quot;--no-verify&quot;</span><span class="p">,</span>  <span class="c1"># We ignore existing WCS</span>
           <span class="s2">&quot;--tweak-order&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
           <span class="s2">&quot;--resort&quot;</span><span class="p">,</span>
           <span class="s2">&quot;--dir&quot;</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">,</span>
           <span class="s2">&quot;--no-plots&quot;</span><span class="p">,</span>
           <span class="s2">&quot;--new-fits&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.fits&quot;</span><span class="p">,</span>
           <span class="n">input_fits_path</span>
      <span class="p">]</span>

    <span class="n">cmd_2</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;solve-field&quot;</span><span class="p">,</span>
           <span class="s2">&quot;--overwrite&quot;</span><span class="p">,</span>
           <span class="s2">&quot;--downsample&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span>
           <span class="s2">&quot;--crpix-center&quot;</span><span class="p">,</span>
           <span class="s2">&quot;--tweak-order&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="c1"># SIP order 3!</span>
           <span class="s2">&quot;--resort&quot;</span><span class="p">,</span>
           <span class="s2">&quot;--dir&quot;</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">,</span>
           <span class="s2">&quot;--verify&quot;</span><span class="p">,</span> <span class="n">input_wcs_path</span><span class="p">,</span>  <span class="c1"># We verify the WCS from run 1</span>
           <span class="s2">&quot;--no-verify-uniformize&quot;</span><span class="p">,</span>
           <span class="s2">&quot;--objs&quot;</span><span class="p">,</span> <span class="s2">&quot;1000000&quot;</span><span class="p">,</span> <span class="c1"># We want to use all available stars</span>
           <span class="s2">&quot;--no-plots&quot;</span><span class="p">,</span>
           <span class="s2">&quot;--new-fits&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.fits&quot;</span><span class="p">,</span>
           <span class="n">input_fits_path</span>
      <span class="p">]</span>

    <span class="k">if</span> <span class="n">settings</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd_1</span>
    <span class="k">elif</span> <span class="n">settings</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd_2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;settings must be 1 or 2&quot;</span><span class="p">)</span>

    <span class="c1"># Creating a log file:</span>
    <span class="n">log_filepath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span> <span class="o">/</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">input_fits_path</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.log&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filepath</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    
    <span class="c1"># And running solve-field:</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">log_file</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>

    <span class="n">log_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Log file: </span><span class="si">{</span><span class="n">log_filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">returncode</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We&#39;ll ignore some astropy warnings that get raised as the corr files written by solve-field have non-compliant units:</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">astropy</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">UnitsWarning</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally we run over all the input files. In case of a failure (in practice: lack of stars due to clouds etc) the image will simply get ignored.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Looping over the input files:</span>

<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">science_file</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">science_files</span><span class="o">.</span><span class="n">files_filtered</span><span class="p">(</span><span class="n">include_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
    
    <span class="n">n_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">science_files</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
    <span class="n">filename_stem</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">science_file</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== Processing image </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_files</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">filename_stem</span><span class="si">}</span><span class="s2"> ===&quot;</span><span class="p">)</span>

    <span class="c1"># Run 1: </span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Run 1&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">run_solvefield</span><span class="p">(</span><span class="n">science_file</span><span class="p">,</span> <span class="n">run_1_dir</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;It failed!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Making a checkplot:</span>
        <span class="n">corr_file_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">run_1_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">science_file</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.corr&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="n">fig_file_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">run_1_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">science_file</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.checkplot.png&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">corr_file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">visualize_corr_file</span><span class="p">(</span><span class="n">corr_file_path</span><span class="p">,</span> <span class="n">fig_file_path</span><span class="o">=</span><span class="n">fig_file_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checkplot: </span><span class="si">{</span><span class="n">fig_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Run 2:</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Run 2&quot;</span><span class="p">)</span>
    
    <span class="n">run_2_input_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">run_1_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">science_file</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
    <span class="n">run_2_input_wcs_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">run_1_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">science_file</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.wcs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">run_solvefield</span><span class="p">(</span><span class="n">run_2_input_path</span><span class="p">,</span> <span class="n">run_2_dir</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">input_wcs_path</span><span class="o">=</span><span class="n">run_2_input_wcs_path</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;It failed!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Making a checkplot:</span>
        <span class="n">corr_file_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">run_2_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">science_file</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.corr&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="n">fig_file_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">run_2_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">science_file</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.checkplot.png&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">corr_file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">visualize_corr_file</span><span class="p">(</span><span class="n">corr_file_path</span><span class="p">,</span> <span class="n">fig_file_path</span><span class="o">=</span><span class="n">fig_file_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checkplot: </span><span class="si">{</span><span class="n">fig_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This last step might take a while, typically 10 s per image. But no need to wait! You can leave it running and start working through the next notebook. Simply re-run the latter once the astrometry is done.</p>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="pre-red.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Image pre-reduction</p>
      </div>
    </a>
    <a class="right-next"
       href="photometry.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Photometry</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By the AIfA telescope team / Malte Tewes
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <p>
All contents released under <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC BY-SA 4.0</a>, unless specified otherwise.<br>
<a href="https://astro.uni-bonn.de/de/institut/impressum" target="_blank">Impressum</a>
</p>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>
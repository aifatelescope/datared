
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Photometry &#8212; AIfA telescope data reduction tutorial</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'photometry';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Colour-magnitude diagram" href="CMD.html" />
    <link rel="prev" title="Astrometric calibration" href="astrometry.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="AIfA telescope data reduction tutorial - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="AIfA telescope data reduction tutorial - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    AIfA telescope data reduction tutorial
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction and setup</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="background-info.html">Introduction to optical observations</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Requirements and installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview-pythontools.html">Structure and Python tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="data.html">Setting up the data</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Basic reduction</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="pre-red.html">Image pre-reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="astrometry.html">Astrometric calibration</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Photometry</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="CMD.html">Colour-magnitude diagram</a></li>
<li class="toctree-l1"><a class="reference internal" href="lightcurve.html">Exoplanet transit light curve</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Further content</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="stack.html">Reprojecting, stacking and colour-combination</a></li>
<li class="toctree-l1"><a class="reference internal" href="camera-charact.html">Camera characterization</a></li>
<li class="toctree-l1"><a class="reference internal" href="more.html">References and links</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/aifatelescope/datared" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/aifatelescope/datared/issues/new?title=Issue%20on%20page%20%2Fphotometry.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/photometry.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Photometry</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-and-subtracting-the-background">Estimating and subtracting the background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#source-detection-and-measurement">Source detection and measurement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#forced-aperture-photometry">Forced aperture photometry</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#chimney-plot">Chimney Plot</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-the-measurements-on-all-images">Performing the measurements on all images</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="photometry">
<h1>Photometry<a class="headerlink" href="#photometry" title="Link to this heading">#</a></h1>
<p>On this page we’ll detect sources and perform simple aperture photometry (along other measurements) for each pre-reduced image.
The same procedure could of course also be applied to coadded images.</p>
<p>As before, you could copy or write the code shown below in a script, or alternatively directly download this page as a <a class="reference download internal" download="" href="_downloads/b3818530518c2677d23c7773e04ac78d/photometry.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">jupyter</span> <span class="pre">notebook</span></code></a> file.</p>
<p>To run the code, you’ll need the module <code class="docutils literal notranslate"><span class="pre">dataredconfig.py</span></code>, as explained <a class="reference internal" href="data.html"><span class="std std-doc">here</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The photometry presented here is sufficient for our purposes, but remains extremely simple. Notably, it ignores the effect of variable seeing (in time and/or accross filters). The next steps to improve upon the minimal approach shown here would be to perform a PSF homogeneization or to use PSF-fitting.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dataredconfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.visualization</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>

<span class="o">%</span><span class="k">matplotlib</span> widget
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ccdproc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">photutils.background</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">photutils.aperture</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">photutils.segmentation</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">photutils.psf</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_filter</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We&#39;ll ignore some astropy warnings that get raised as our FITS headers (from NINA) are not 100% standards compliant.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">astropy</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">FITSFixedWarning</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Setting the correct path to the pre-reduced science frames to work on:</span>
<span class="c1">#science_files_dir = dataredconfig.work_dir / &quot;LIGHT_PRERED&quot; # In case astrometric calibration was already performed before the pre-reduction</span>
<span class="n">science_files_dir</span> <span class="o">=</span> <span class="n">dataredconfig</span><span class="o">.</span><span class="n">work_dir</span> <span class="o">/</span> <span class="s2">&quot;ASTROMETRY&quot;</span>
<span class="n">science_files</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">ImageFileCollection</span><span class="p">(</span><span class="n">science_files_dir</span><span class="p">,</span> <span class="n">keywords</span><span class="o">=</span><span class="n">dataredconfig</span><span class="o">.</span><span class="n">ifc_header_keywords</span><span class="p">)</span>

<span class="c1"># Where to write the catalogs:</span>
<span class="n">photometry_dir</span> <span class="o">=</span> <span class="n">dataredconfig</span><span class="o">.</span><span class="n">work_dir</span> <span class="o">/</span> <span class="s2">&quot;PHOTOMETRY&quot;</span>
<span class="n">photometry_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Overview of all available files:</span>
<span class="n">science_files</span><span class="o">.</span><span class="n">summary</span>
<span class="c1"># You may want to try this instead, for a better display:</span>
<span class="c1">#science_files.summary.show_in_notebook()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Optional: selecting the science frames to run on : </span>
<span class="n">object_to_process</span> <span class="o">=</span> <span class="s2">&quot;HD92670&quot;</span>

<span class="n">science_files</span> <span class="o">=</span> <span class="n">science_files</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">object</span><span class="o">=</span><span class="n">object_to_process</span><span class="p">)</span>

<span class="c1">#science_files.summary</span>
</pre></div>
</div>
</div>
</div>
<p>We will measure photometry on all these files.
But we start by picking one reference image, used to detect sources. It should be a good and deep exposure. We will also use this same image to check the overall procedure.</p>
<p>Note that it doesn’t have to be the first one. Select another index below if your first image is bad for some reason.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ref_image_filepath</span> <span class="o">=</span> <span class="n">science_files</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ref_image</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ref_image_filepath</span><span class="p">)</span>

<span class="k">if</span><span class="p">(</span><span class="n">ref_image</span><span class="o">.</span><span class="n">wcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="c1"># Performing forced photometry requires each frame to have a good WCS. This test is just to avoid obvious mistakes.</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The image has no WCS, make sure you specify the correct directory (i.e., with WCS) above!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="estimating-and-subtracting-the-background">
<h2>Estimating and subtracting the background<a class="headerlink" href="#estimating-and-subtracting-the-background" title="Link to this heading">#</a></h2>
<p>The background estimation is run individually on every image (as the background might well change, e.g., due to clouds, light pollution, or stray light. We therefore start by defining a function for background estimation.
Depending on the data to be processed, you might have to adjust the parameters of this function, to tune the “flexibility” of the background model to your science objective. The given default values are often ok, but certaintly not optimal for every situation.</p>
<p>The typical compromise in background estimation is driven by the following. If the background model is too flexible, the background subtraction will take away some light from larger objects (such as galaxies, but also the central regions of star clusters). And if it is to rigid, the model won’t be able to properly fit the structure that the background might have.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">estimate_background</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">box_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to estimate the background and its RMS (root-mean-square deviation).</span>
<span class="sd">    This is a simplifying wrapper around photutils, to expose and explain a bit the two key parameters box_size and filter_size.</span>
<span class="sd">    </span>
<span class="sd">    In short, the background is calculated by interpolating some sigma-clipped statistics evaluated on a relatively coarse grid.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    image: a CCDData object</span>
<span class="sd">    box_size: defines how fine the coarse grid is, in pixels.</span>
<span class="sd">        The background gets estimated in each box of size box_size.</span>
<span class="sd">        Ideally this is larger than the largest obects, but smaller than the background structure.</span>
<span class="sd">    filter_size: an odd integer: window size of the median filter that gets applied to the measurements on the coarse grid.</span>
<span class="sd">        This median filter helps for example to avoid &quot;bumps&quot; from large diffuse objects. </span>

<span class="sd">    For more details, see https://photutils.readthedocs.io/en/stable/user_guide/background.html</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    background, background_rms: two numpy arrays</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">bkg</span> <span class="o">=</span> <span class="n">photutils</span><span class="o">.</span><span class="n">background</span><span class="o">.</span><span class="n">Background2D</span><span class="p">(</span>
        <span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="n">box_size</span><span class="o">=</span><span class="p">(</span><span class="n">box_size</span><span class="p">,</span> <span class="n">box_size</span><span class="p">),</span>
        <span class="n">filter_size</span><span class="o">=</span><span class="p">(</span><span class="n">filter_size</span><span class="p">,</span> <span class="n">filter_size</span><span class="p">),</span>
        <span class="n">bkg_estimator</span><span class="o">=</span><span class="n">photutils</span><span class="o">.</span><span class="n">background</span><span class="o">.</span><span class="n">MedianBackground</span><span class="p">()</span>
        <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="n">bkg</span><span class="o">.</span><span class="n">background_rms</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s apply this to the reference image, to experiment with the parameters.</p>
<p>If the background you want to subtract has relatively fine structures, try reducing box_size and simultaneouly increasing filter_size in the call below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We run this on the reference image</span>
<span class="n">background_box_size</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">background_filter_size</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">background</span><span class="p">,</span> <span class="n">background_rms</span> <span class="o">=</span> <span class="n">estimate_background</span><span class="p">(</span><span class="n">ref_image</span><span class="p">,</span> <span class="n">box_size</span><span class="o">=</span><span class="n">background_box_size</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="n">background_filter_size</span><span class="p">)</span>

<span class="c1"># Visualize the background image</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Background model&quot;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">background</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cbar</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pixel value [ADU]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x [pixel]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;y [pixel]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We subtract the background from the reference image</span>
<span class="n">ref_image_noback</span> <span class="o">=</span> <span class="n">ref_image</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">ccdproc</span><span class="o">.</span><span class="n">CCDData</span><span class="p">(</span><span class="n">background</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;adu&quot;</span><span class="p">))</span>

<span class="c1"># And visualize how &quot;flat&quot; the background-subtracted reference image is.</span>
<span class="c1"># We smooth this slightly, to reduce noise and better see the structure.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Background-subtracted image, smoothed&quot;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">ref_image_noback</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">20</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cbar</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pixel value [ADU]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x [pixel]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;y [pixel]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The above two visualizations will probably never look perfect, as background subtraction is difficult (way more sophisticated approaches exist). Explore if you can improve it by adjusting the background estimation parameters, otherwise keep the default values.</p>
<p>In preparation for the source detection, we also have to define a “threshold” image for this reference frame, whose values are multiples of the estimated RMS of the background in each pixel.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># (RMS is an estimate of the standard deviation, so 3*RMS is &quot;3 sigma&quot; above the background)</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">background_rms</span> <span class="c1"># this is an array</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="source-detection-and-measurement">
<h2>Source detection and measurement<a class="headerlink" href="#source-detection-and-measurement" title="Link to this heading">#</a></h2>
<p>We now detect sources (as groups of connected pixels above the threshold) and measure their exact positions (among other parameters), on the selected reference image. Let’s nevertheless group all this in a function again.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">detect_and_measure</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to detect and measure sources.</span>
<span class="sd">    This is close to what Source Extractor typically does.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    image: a CCDData object</span>
<span class="sd">    threshold: a 2D-array with threshold values</span>

<span class="sd">    Returns:</span>
<span class="sd">    An Astropy Table with source positions (from  windowed centroids, </span>
<span class="sd">    both in pixel and sky coordinates) and other measurements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span> 

    <span class="c1"># Filtering (convolving with a 2D Gaussian) for better source detection</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">photutils</span><span class="o">.</span><span class="n">segmentation</span><span class="o">.</span><span class="n">make_2dgaussian_kernel</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span>  <span class="c1"># FWHM in pixels</span>
    <span class="n">convolved_data</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">convolution</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>

    <span class="c1"># Segmenting the image</span>
    <span class="n">finder</span> <span class="o">=</span> <span class="n">photutils</span><span class="o">.</span><span class="n">segmentation</span><span class="o">.</span><span class="n">SourceFinder</span><span class="p">(</span><span class="n">npixels</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">connectivity</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">segment_map</span> <span class="o">=</span> <span class="n">finder</span><span class="p">(</span><span class="n">convolved_data</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
    <span class="c1">#segment_map = finder(data, threshold) # One could also run this on the unfiltered image</span>

    <span class="c1"># And measuring sources</span>
    <span class="n">source_catalog</span> <span class="o">=</span> <span class="n">photutils</span><span class="o">.</span><span class="n">segmentation</span><span class="o">.</span><span class="n">SourceCatalog</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">segment_map</span><span class="p">,</span> <span class="n">convolved_data</span><span class="o">=</span><span class="n">convolved_data</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>
    <span class="n">source_table</span> <span class="o">=</span> <span class="n">source_catalog</span><span class="o">.</span><span class="n">to_table</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;xcentroid_win&quot;</span><span class="p">,</span> <span class="s2">&quot;ycentroid_win&quot;</span><span class="p">,</span> <span class="s2">&quot;sky_centroid_win&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;fwhm&quot;</span><span class="p">,</span> <span class="s2">&quot;max_value&quot;</span><span class="p">,</span> <span class="s2">&quot;kron_flux&quot;</span><span class="p">,</span> <span class="s2">&quot;segment_flux&quot;</span><span class="p">,</span> <span class="s2">&quot;segment_area&quot;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">source_table</span><span class="p">)</span> <span class="c1"># We convert the QTable to a Table, better for later FITS writing.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run this on the reference image</span>
<span class="n">ref_catalog</span> <span class="o">=</span> <span class="n">detect_and_measure</span><span class="p">(</span><span class="n">ref_image_noback</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reference catalog: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ref_catalog</span><span class="p">)</span><span class="si">}</span><span class="s2"> sources detected.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>After running a detection, it’s almost mandatory to check the result with a visualization! We do this with the following interactive Figure.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Figure that overplots the image and the positions of the detected sources</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">ref_image_noback</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_image_noback</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
    <span class="n">norm</span><span class="o">=</span><span class="n">astropy</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">simple_norm</span><span class="p">(</span><span class="n">ref_image_noback</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">20</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">2000</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">ref_catalog</span><span class="p">[</span><span class="s2">&quot;xcentroid_win&quot;</span><span class="p">],</span>
    <span class="n">ref_catalog</span><span class="p">[</span><span class="s2">&quot;ycentroid_win&quot;</span><span class="p">],</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;pixel&#39;</span><span class="p">),</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="c1"># The size of these markers is not related to any measurement apertures!</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span>
    <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;RA&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Dec&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Zoom in and check if all relevant sources are detected. If there are issues, one might have to adjust the sensitivity of the detection.</p>
<p>Depending on your science objective, you can save CPU-time by setting a flux threshold to keep only those stars you actually care about, and not every tiny detection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Apply some flux cut, to remove fainter sources if those are not needed:</span>
<span class="n">ref_catalog</span> <span class="o">=</span> <span class="n">ref_catalog</span><span class="p">[</span><span class="n">ref_catalog</span><span class="p">[</span><span class="s2">&quot;kron_flux&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">]</span>
<span class="nb">len</span><span class="p">(</span><span class="n">ref_catalog</span><span class="p">)</span>

<span class="c1"># Now rerun the vizualisation above to see the effect, and adapt the threshold if needed!</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For reference, we write the reference catalog in this directory.</span>
<span class="c1"># Note that this catalog also contains the aperture positions in sky coordinates.</span>
<span class="n">ref_catalog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">photometry_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;ref_catalog_</span><span class="si">{</span><span class="n">object_to_process</span><span class="si">}</span><span class="s2">.fits&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="forced-aperture-photometry">
<h2>Forced aperture photometry<a class="headerlink" href="#forced-aperture-photometry" title="Link to this heading">#</a></h2>
<p>We’ll now perform forced aperture photometry on all science images of our target, with a series of aperture sizes (radii given in arcseconds in the code below).
This means that we use the sky coordinates of the sources detected in the reference frame to place the same apertures on all dithered exposures of the target.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We group all steps of the photometric measurement into one function:</span>

<span class="k">def</span><span class="w"> </span><span class="nf">measure_photometry</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">sky_positions</span><span class="p">,</span> <span class="n">run_simple_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">background_box_size</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">background_filter_size</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function for forced aperture photometry given the provided sky_positions.</span>
<span class="sd">    This function first estimates and subtracts the background from the image,</span>
<span class="sd">    and performs aperture photometry both on the background-subtracted image and on the background alone.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    image: a CCDData object</span>
<span class="sd">    sky_positions: a list or column of aperture positions, in sky coordinates (i.e. as SkyCoord objects)</span>
<span class="sd">    run_fit: if True, a simple 2D Gaussian fit is also run, providing FWHM and flux measurements. Take significantly more time.</span>

<span class="sd">    Returns:</span>
<span class="sd">    An Astropy Table with measurements for several aperture radii at the given positions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Estimating and subtracting the background:</span>
    <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>    
    <span class="n">background</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">estimate_background</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">box_size</span><span class="o">=</span><span class="n">background_box_size</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="n">background_filter_size</span><span class="p">)</span>
    <span class="n">image_noback</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">ccdproc</span><span class="o">.</span><span class="n">CCDData</span><span class="p">(</span><span class="n">background</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;adu&quot;</span><span class="p">))</span>
    <span class="n">tend</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Background subtraction took </span><span class="si">{</span><span class="n">tend</span><span class="o">-</span><span class="n">tstart</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> sec&quot;</span><span class="p">)</span>
    
    
    <span class="c1"># Aperture photometry</span>
    <span class="n">aperture_radii</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span> <span class="c1"># In arcsec</span>
    <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="c1"># We generate a separate catalog for each aperture radius, and combine these afterwards</span>
    <span class="n">aperture_catalogs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">aperture_radii</span><span class="p">:</span>

        <span class="n">apertures</span> <span class="o">=</span> <span class="n">photutils</span><span class="o">.</span><span class="n">aperture</span><span class="o">.</span><span class="n">SkyCircularAperture</span><span class="p">(</span><span class="n">sky_positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>

        <span class="c1"># Photometry on the background-subtracted image:</span>
        <span class="n">aperture_measurements</span> <span class="o">=</span> <span class="n">photutils</span><span class="o">.</span><span class="n">aperture</span><span class="o">.</span><span class="n">ApertureStats</span><span class="p">(</span><span class="n">image_noback</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aperture</span><span class="o">=</span><span class="n">apertures</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">image_noback</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>
        <span class="c1"># Same photometry on the background image:</span>
        <span class="n">background_aperture_measurements</span> <span class="o">=</span> <span class="n">photutils</span><span class="o">.</span><span class="n">aperture</span><span class="o">.</span><span class="n">ApertureStats</span><span class="p">(</span><span class="n">background</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">aperture</span><span class="o">=</span><span class="n">apertures</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">image_noback</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>
        
        <span class="n">aperture_catalog</span> <span class="o">=</span> <span class="n">aperture_measurements</span><span class="o">.</span><span class="n">to_table</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">])</span>
        <span class="n">background_aperture_catalog</span> <span class="o">=</span> <span class="n">background_aperture_measurements</span><span class="o">.</span><span class="n">to_table</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">])</span>

        <span class="c1"># Note: ApertureStats also provides &quot;fwhm&quot; and &quot;elongation&quot;, among other stats.</span>
        <span class="c1"># While these measurements are fast and can be useful, they are computed from unweighted moments,</span>
        <span class="c1"># and will therefore be strongly influenced by the aperture size and the noise.</span>
        <span class="c1"># Just for reference, this is how to get them:</span>
        <span class="c1">#aperture_catalog = aperture_measurements.to_table(columns=[&quot;fwhm&quot;, &quot;elongation&quot;, &quot;sum&quot;])        </span>

        <span class="c1"># Rename columns by adding the aperture radius, to get for example &quot;sum_4&quot; instead of sum</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">aperture_catalog</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="n">aperture_catalog</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">background_aperture_catalog</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="n">background_aperture_catalog</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;back_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
         
        <span class="n">aperture_catalogs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aperture_catalog</span><span class="p">)</span>
        <span class="n">aperture_catalogs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">background_aperture_catalog</span><span class="p">)</span>
    
    <span class="c1"># And now merge these catalogs into a single one:</span>
    <span class="n">merged_catalog</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">aperture_catalogs</span><span class="p">,</span>
        <span class="n">join_type</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">,</span> <span class="n">metadata_conflicts</span><span class="o">=</span><span class="s2">&quot;silent&quot;</span>
        <span class="p">)</span>
    <span class="n">tend</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Photometry took </span><span class="si">{</span><span class="n">tend</span><span class="o">-</span><span class="n">tstart</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> sec&quot;</span><span class="p">)</span>


    <span class="c1"># Optional simple 2D Gaussian fit for FWHM-measurement of sources:</span>
    <span class="k">if</span> <span class="n">run_simple_fit</span><span class="p">:</span>
        <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> 
        <span class="c1"># Compute pixel-coordinate positions of the positions:</span>
        <span class="n">image_pixel_positions</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">skycoord_to_pixel</span><span class="p">(</span><span class="n">sky_positions</span><span class="p">,</span> <span class="n">image_noback</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>
        <span class="n">xypos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image_pixel_positions</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span> <span class="c1"># Rearranging the data</span>
        <span class="c1"># Add empty columns to hold the measurements:</span>
        <span class="n">merged_catalog</span><span class="o">.</span><span class="n">add_columns</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fwhm_fit&quot;</span><span class="p">,</span> <span class="s2">&quot;flux_fit&quot;</span><span class="p">,</span> <span class="s2">&quot;q_fit&quot;</span><span class="p">])</span>
        <span class="c1"># And loop over the sources.</span>
        <span class="c1"># We need this loop as some sources might be outside of a particular exposure, raising exceptions.</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xypos</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                    <span class="n">fit_results</span> <span class="o">=</span> <span class="n">photutils</span><span class="o">.</span><span class="n">psf</span><span class="o">.</span><span class="n">fit_2dgaussian</span><span class="p">(</span><span class="n">image_noback</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">xypos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">fit_shape</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">fix_fwhm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">results</span>
                    <span class="n">merged_catalog</span><span class="p">[</span><span class="s2">&quot;fwhm_fit&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_results</span><span class="p">[</span><span class="s2">&quot;fwhm_fit&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">merged_catalog</span><span class="p">[</span><span class="s2">&quot;flux_fit&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_results</span><span class="p">[</span><span class="s2">&quot;flux_fit&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">merged_catalog</span><span class="p">[</span><span class="s2">&quot;q_fit&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_results</span><span class="p">[</span><span class="s2">&quot;qfit&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fit failed for source </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">tend</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;2D Gaussian fitting took </span><span class="si">{</span><span class="n">tend</span><span class="o">-</span><span class="n">tstart</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> sec&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">merged_catalog</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># As a test, we run this on the ref_image.</span>
<span class="c1"># For this we read the ref image again, as the one in memory already has the background subtracted.</span>
<span class="n">ref_image</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ref_image_filepath</span><span class="p">)</span>
<span class="n">ref_photo_cat</span> <span class="o">=</span> <span class="n">measure_photometry</span><span class="p">(</span><span class="n">ref_image</span><span class="p">,</span> <span class="n">ref_catalog</span><span class="p">[</span><span class="s2">&quot;sky_centroid_win&quot;</span><span class="p">],</span>
                                   <span class="n">run_simple_fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">background_box_size</span> <span class="o">=</span> <span class="n">background_box_size</span><span class="p">,</span>
                                   <span class="n">background_filter_size</span> <span class="o">=</span> <span class="n">background_filter_size</span>
                                   <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ref_photo_cat</span><span class="o">.</span><span class="n">colnames</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To summarize, the columns are the following.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sum_x</span></code> is the background-subtracted flux within the aperture of radius <code class="docutils literal notranslate"><span class="pre">x</span></code> arcsec. This is what we’ll use to compute magnitudes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">max_x</span></code> is the maximum pixel value within the corresponding aperture. This informs us if some pixels are at or close to saturation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">back_sum_x</span></code> is the flux of the background within the corresponding aperture. This could be used later to estimate the noise of the photometry.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fwhm_fit</span></code>, <code class="docutils literal notranslate"><span class="pre">flux_fit</span></code>, <code class="docutils literal notranslate"><span class="pre">q_fit</span></code> are measurements from the optional 2D Gaussian fit.</p></li>
</ul>
<section id="chimney-plot">
<h3>Chimney Plot<a class="headerlink" href="#chimney-plot" title="Link to this heading">#</a></h3>
<p>As an illustration of how this photometric catalog can be used, we create a basic and very common scatter plot: the so-called “chimney plot”, named after its shape. The plot shows instrumental magnitude against FWHM (or some other size measurement) of all detected sources.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Potentially, your image contains both unresolved sources (stars) and resolved sources (e.g., galaxies). This plot should show you a clear “stellar locus” (i.e., where the stars are), and directly tell you the seeing of this particular image. Can you measure it? A potential fine “smoke plume” coming from your chimney is related to the saturation of the brightest stars.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Just as an example, let&#39;s use the flux within the apertures of 6 arcseconds: </span>
<span class="n">ref_photo_cat</span><span class="p">[</span><span class="s2">&quot;mag_6&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ref_photo_cat</span><span class="p">[</span><span class="s2">&quot;sum_6&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="c1"># We create a scatter plot of FWHM versus mag, and color the datapoints according to the q_fit parameter (see legend).</span>
<span class="c1"># High values of q_fit indicate that the source was not well fitted by the simple 2D-Gaussian.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
    <span class="n">ref_photo_cat</span><span class="p">[</span><span class="s2">&quot;fwhm_fit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> 
    <span class="n">ref_photo_cat</span><span class="p">[</span><span class="s2">&quot;mag_6&quot;</span><span class="p">],</span> 
    <span class="n">c</span><span class="o">=</span><span class="n">ref_photo_cat</span><span class="p">[</span><span class="s2">&quot;q_fit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
    <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span>
    <span class="n">s</span><span class="o">=</span><span class="mi">10</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span> <span class="c1"># Bright is at the top!</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fit quality metric: sum(abs(fit residuals)) / (fitted flux)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;FWHM [pix]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Instrumental magnitude&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="performing-the-measurements-on-all-images">
<h3>Performing the measurements on all images<a class="headerlink" href="#performing-the-measurements-on-all-images" title="Link to this heading">#</a></h3>
<p>Finally, we apply this measurement function to all images of the object.</p>
<p>If you don’t need the Gaussian fitting, you can run this faster by setting <code class="docutils literal notranslate"><span class="pre">run_simple_fit=False</span></code> below, in the call of <code class="docutils literal notranslate"><span class="pre">measure_photometry()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We read again the ref catalog from file:</span>
<span class="n">ref_catalog</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">photometry_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;ref_catalog_</span><span class="si">{</span><span class="n">object_to_process</span><span class="si">}</span><span class="s2">.fits&quot;</span><span class="p">)</span>


<span class="n">n_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">science_files</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
<span class="c1"># And now we loop over all selected exposures:</span>
<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">science_file</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">science_files</span><span class="o">.</span><span class="n">files</span><span class="p">):</span>

    <span class="n">image_filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">science_file</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
    <span class="n">output_filepath</span> <span class="o">=</span> <span class="n">photometry_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_filename</span><span class="si">}</span><span class="s2">.fits&quot;</span>

    <span class="c1"># Could use something like that to relaunch on new or selected files:</span>
    <span class="c1">#if output_filepath.exists():</span>
    <span class="c1">#    continue</span>
    <span class="c1"># Or, alternatively:</span>
    <span class="c1">#if i &lt; 104:</span>
    <span class="c1">#    continue</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== Processing image </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_files</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">image_filename</span><span class="si">}</span><span class="s2"> ===&quot;</span><span class="p">)</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">ccdproc</span><span class="o">.</span><span class="n">CCDData</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">science_file</span><span class="p">)</span>

    <span class="c1"># We build a dict containing some meta-information of the image taken from the FITS header.</span>
    <span class="c1"># We&#39;ll later write this as meta-information of the catalogue.</span>
    <span class="n">meta_from_image</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">&quot;DATE-OBS&quot;</span><span class="p">,</span> <span class="s2">&quot;EXPTIME&quot;</span><span class="p">,</span> <span class="s2">&quot;IMAGETYP&quot;</span><span class="p">,</span> <span class="s2">&quot;AIRMASS&quot;</span><span class="p">,</span> <span class="s2">&quot;PIERSIDE&quot;</span><span class="p">,</span> <span class="s2">&quot;FILTER&quot;</span><span class="p">,</span> <span class="s2">&quot;OBJECT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FOCUSPOS&quot;</span><span class="p">,</span> <span class="s2">&quot;FOCTEMP&quot;</span><span class="p">,</span> <span class="s2">&quot;RA&quot;</span><span class="p">,</span> <span class="s2">&quot;DEC&quot;</span><span class="p">,</span> <span class="s2">&quot;SET-TEMP&quot;</span><span class="p">,</span> <span class="s2">&quot;CCD-TEMP&quot;</span><span class="p">,</span> <span class="s2">&quot;GAIN&quot;</span><span class="p">,</span> <span class="s2">&quot;OFFSET&quot;</span>
        <span class="p">]}</span>
    
    <span class="c1"># Now run the measurements:</span>
    <span class="n">catalog</span> <span class="o">=</span> <span class="n">measure_photometry</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">ref_catalog</span><span class="p">[</span><span class="s2">&quot;sky_centroid_win&quot;</span><span class="p">],</span>
                                 <span class="n">run_simple_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="n">background_box_size</span> <span class="o">=</span> <span class="n">background_box_size</span><span class="p">,</span>
                                 <span class="n">background_filter_size</span> <span class="o">=</span> <span class="n">background_filter_size</span>
                                 <span class="p">)</span>

    <span class="c1"># Add the information from the FITS header</span>
    <span class="n">catalog</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">meta_from_image</span><span class="p">)</span>

    <span class="c1"># Could copy a few columns from the reference catalog</span>
    <span class="c1"># But no need to do this here: we keep the reference catalog, and will use it later. </span>
    <span class="c1">#catalog[&quot;sky_centroid_win&quot;] = ref_catalog[&quot;sky_centroid_win&quot;]</span>

    <span class="c1"># And write all this as a FITS table</span>
    <span class="n">catalog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_filepath</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Again, this might take a while to run if you have many exposures. In particular if you’re analysing a transit, you can leave this cell running and start setting up the next notebook.</p>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="astrometry.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Astrometric calibration</p>
      </div>
    </a>
    <a class="right-next"
       href="CMD.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Colour-magnitude diagram</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-and-subtracting-the-background">Estimating and subtracting the background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#source-detection-and-measurement">Source detection and measurement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#forced-aperture-photometry">Forced aperture photometry</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#chimney-plot">Chimney Plot</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performing-the-measurements-on-all-images">Performing the measurements on all images</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By the AIfA telescope team / Malte Tewes
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <p>
All contents released under <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC BY-SA 4.0</a>, unless specified otherwise.<br>
<a href="https://astro.uni-bonn.de/de/institut/impressum" target="_blank">Impressum</a>
</p>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>